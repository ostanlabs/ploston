# =============================================================================
# Promote Release Candidate (RC) to Production
# =============================================================================
# Promotes an RC image to production tags after E2E tests pass.
# Triggered by the meta-repo when all tests pass.
#
# Promoted tags:
#   - docker.io/ostanlabs/ploston:latest
#   - docker.io/ostanlabs/ploston:main
#
# Triggered by:
#   - repository_dispatch from meta-repo (rc-tests-passed event)
#   - Manual workflow dispatch
# =============================================================================

name: Promote RC

on:
  repository_dispatch:
    types: [rc-tests-passed]
  
  workflow_dispatch:
    inputs:
      image:
        description: 'RC image to promote (e.g., docker.io/ostanlabs/ploston:rc-abc1234)'
        required: true
      sha:
        description: 'Source commit SHA'
        required: false
        default: 'manual'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ostanlabs/ploston

jobs:
  promote:
    name: Promote RC to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Determine image to promote
        id: image
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "tag=${{ github.event.client_payload.image }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
            echo "run_url=${{ github.event.client_payload.run_url }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.inputs.image }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.inputs.sha }}" >> $GITHUB_OUTPUT
            echo "run_url=manual" >> $GITHUB_OUTPUT
          fi
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Pull RC image
        run: docker pull ${{ steps.image.outputs.tag }}
      
      - name: Tag and push as latest
        run: |
          docker tag ${{ steps.image.outputs.tag }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
      
      - name: Tag and push as main
        run: |
          docker tag ${{ steps.image.outputs.tag }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
      
      - name: Summary
        run: |
          echo "## RC Promoted to Production! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**RC Image:** \`${{ steps.image.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Source SHA:** ${{ steps.image.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted to:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.image.outputs.run_url }}" != "manual" ]; then
            echo "**Test Run:** ${{ steps.image.outputs.run_url }}" >> $GITHUB_STEP_SUMMARY
          fi

