# =============================================================================
# Rebuild on Core Update (Cascade)
# =============================================================================
# Triggered by meta-repo when ploston-core is updated.
# Rebuilds the package with the new core version and reports back.
#
# Flow:
#   1. Meta-repo dispatches 'rebuild' event with cascade_id and core_version
#   2. This workflow rebuilds images with the new core version
#   3. Dispatches 'build-complete' back to meta-repo with results
# =============================================================================

name: Rebuild (Cascade)

on:
  repository_dispatch:
    types: [rebuild]

concurrency:
  group: ${{ github.repository }}-builds
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  check-skip:
    name: Check if rebuild can be skipped
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      existing_tag: ${{ steps.check.outputs.existing_tag }}
    steps:
      - name: Check for existing image with this core version
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CORE_VERSION="${{ github.event.client_payload.core_version }}"
          # Check if an image already exists for this core version
          # by looking for images with the core_version label
          # For now, we don't skip - always rebuild
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "existing_tag=" >> $GITHUB_OUTPUT

  rebuild:
    name: Rebuild with new ploston-core
    needs: check-skip
    if: needs.check-skip.outputs.skip != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      image_tag: ${{ steps.tags.outputs.tag }}
      ploston_image: ${{ steps.build-ploston.outputs.image }}
      native_tools_image: ${{ steps.build-native-tools.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine image tags
        id: tags
        run: |
          # Use short SHA for tag
          TAG="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "::notice::Image tag: $TAG"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ploston image
        id: build-ploston
        run: |
          IMAGE="${{ env.REGISTRY }}/ostanlabs/ploston-dev:${{ steps.tags.outputs.tag }}"
          CORE_VERSION="${{ github.event.client_payload.core_version }}"

          docker build \
            --build-arg PLOSTON_CORE_VERSION="${CORE_VERSION}" \
            --label "org.opencontainers.image.source=https://github.com/ostanlabs/ploston" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "com.ostanlabs.ploston-core.version=${CORE_VERSION}" \
            --label "com.ostanlabs.cascade-id=${{ github.event.client_payload.cascade_id }}" \
            -t $IMAGE \
            -f Dockerfile .

          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "::notice::Built ploston image: $IMAGE"

      - name: Build and push native-tools image
        id: build-native-tools
        run: |
          IMAGE="${{ env.REGISTRY }}/ostanlabs/native-tools-dev:${{ steps.tags.outputs.tag }}"
          CORE_VERSION="${{ github.event.client_payload.core_version }}"

          docker build \
            --build-arg PLOSTON_CORE_VERSION="${CORE_VERSION}" \
            --label "org.opencontainers.image.source=https://github.com/ostanlabs/ploston" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "com.ostanlabs.ploston-core.version=${CORE_VERSION}" \
            --label "com.ostanlabs.cascade-id=${{ github.event.client_payload.cascade_id }}" \
            -t $IMAGE \
            -f docker/native-tools/Dockerfile .

          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "::notice::Built native-tools image: $IMAGE"

  report-success:
    name: Report Success to Meta-Repo
    needs: [rebuild]
    if: success()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Dispatch build-complete (success)
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: build-complete
          client-payload: |
            {
              "cascade_id": "${{ github.event.client_payload.cascade_id }}",
              "repo": "ploston",
              "sha": "${{ github.sha }}",
              "core_version": "${{ github.event.client_payload.core_version }}",
              "status": "success",
              "error": null,
              "artifact": {
                "image_tag": "${{ needs.rebuild.outputs.image_tag }}",
                "images": {
                  "ploston": "${{ needs.rebuild.outputs.ploston_image }}",
                  "native_tools": "${{ needs.rebuild.outputs.native_tools_image }}"
                }
              }
            }

  report-failure:
    name: Report Failure to Meta-Repo
    needs: [check-skip, rebuild]
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Dispatch build-complete (failure)
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: build-complete
          client-payload: |
            {
              "cascade_id": "${{ github.event.client_payload.cascade_id }}",
              "repo": "ploston",
              "sha": "${{ github.sha }}",
              "core_version": "${{ github.event.client_payload.core_version }}",
              "status": "failure",
              "error": "Build failed - check workflow run for details",
              "artifact": null
            }

