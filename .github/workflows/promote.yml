# =============================================================================
# Promote - Release RC to Production
# =============================================================================
# Promotes RC images to production tags.
#
# Triggers:
#   - repository_dispatch (rc-tests-passed): Auto-promote after E2E tests pass
#     ‚Üí Tags: :dev-<commit_hash>, :dev (preserves history)
#   - GitHub Release: Versioned release
#     ‚Üí Tags: :v1.0.0, :1.0, :1, :latest
#   - Manual: Specify RC image and target tags
#
# Both ploston and native-tools images are promoted together.
# =============================================================================

name: Promote

on:
  repository_dispatch:
    types: [rc-tests-passed]

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      image:
        description: 'RC image to promote (e.g., docker.io/ostanlabs/ploston:rc-abc1234-core-def5678)'
        required: true
      tags:
        description: 'Comma-separated tags to apply (e.g., latest,main)'
        required: true
        default: 'latest,main'

jobs:
  promote:
    name: Promote to Production
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.params.outputs.short_sha }}
      tags: ${{ steps.params.outputs.tags }}

    steps:
      - name: Fetch image config from meta-repo
        id: config
        run: |
          # Fetch the single source of truth for image naming
          curl -sL https://raw.githubusercontent.com/ostanlabs/agent-execution-layer/main/ci/image-config.env -o image-config.env
          source image-config.env

          # Export config values (stage-specific image names)
          echo "registry=${PUBLIC_REGISTRY}" >> $GITHUB_OUTPUT
          echo "org=${PUBLIC_ORG}" >> $GITHUB_OUTPUT
          # Dev stage image names (for dev promotion)
          echo "ploston_dev_image=${PLOSTON_DEV_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "native_tools_dev_image=${NATIVE_TOOLS_DEV_IMAGE_NAME}" >> $GITHUB_OUTPUT
          # Release stage image names
          echo "ploston_release_image=${PLOSTON_RELEASE_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "native_tools_release_image=${NATIVE_TOOLS_RELEASE_IMAGE_NAME}" >> $GITHUB_OUTPUT
          # Tag templates
          echo "dev_tag_template=${DEV_TAG_TEMPLATE}" >> $GITHUB_OUTPUT
          echo "dev_latest_tag=${DEV_LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "release_tag_template=${RELEASE_TAG_TEMPLATE}" >> $GITHUB_OUTPUT
          echo "release_latest_tag=${RELEASE_LATEST_TAG}" >> $GITHUB_OUTPUT

      - name: Determine promotion parameters
        id: params
        env:
          DEV_TAG_TEMPLATE: ${{ steps.config.outputs.dev_tag_template }}
          DEV_LATEST_TAG: ${{ steps.config.outputs.dev_latest_tag }}
          RELEASE_TAG_TEMPLATE: ${{ steps.config.outputs.release_tag_template }}
          RELEASE_LATEST_TAG: ${{ steps.config.outputs.release_latest_tag }}
          REGISTRY: ${{ steps.config.outputs.registry }}
          ORG: ${{ steps.config.outputs.org }}
          PLOSTON_DEV_IMAGE: ${{ steps.config.outputs.ploston_dev_image }}
          NATIVE_TOOLS_DEV_IMAGE: ${{ steps.config.outputs.native_tools_dev_image }}
          PLOSTON_RELEASE_IMAGE: ${{ steps.config.outputs.ploston_release_image }}
          NATIVE_TOOLS_RELEASE_IMAGE: ${{ steps.config.outputs.native_tools_release_image }}
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            SHA="${{ github.event.client_payload.sha }}"
            SHORT_SHA="${SHA:0:7}"
            echo "image=${{ github.event.client_payload.image }}" >> $GITHUB_OUTPUT
            echo "native_tools_image=${{ github.event.client_payload.native_tools_image }}" >> $GITHUB_OUTPUT
            # Use tag template from config (replace {short_sha} placeholder)
            DEV_TAG="${DEV_TAG_TEMPLATE//\{short_sha\}/$SHORT_SHA}"
            echo "tags=${DEV_TAG},${DEV_LATEST_TAG}" >> $GITHUB_OUTPUT
            echo "sha=$SHA" >> $GITHUB_OUTPUT
            echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
            echo "source=e2e-passed" >> $GITHUB_OUTPUT
            # Store full image refs for promotion (using dev stage image names)
            echo "ploston_full=${REGISTRY}/${ORG}/${PLOSTON_DEV_IMAGE}" >> $GITHUB_OUTPUT
            echo "native_tools_full=${REGISTRY}/${ORG}/${NATIVE_TOOLS_DEV_IMAGE}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            # Use tag templates from config
            echo "tags=${VERSION},${MAJOR}.${MINOR},${MAJOR},${RELEASE_LATEST_TAG}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "source=release" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            # Use release stage image names
            echo "ploston_full=${REGISTRY}/${ORG}/${PLOSTON_RELEASE_IMAGE}" >> $GITHUB_OUTPUT
            echo "native_tools_full=${REGISTRY}/${ORG}/${NATIVE_TOOLS_RELEASE_IMAGE}" >> $GITHUB_OUTPUT
          else
            echo "image=${{ github.event.inputs.image }}" >> $GITHUB_OUTPUT
            echo "tags=${{ github.event.inputs.tags }}" >> $GITHUB_OUTPUT
            echo "sha=manual" >> $GITHUB_OUTPUT
            echo "source=manual" >> $GITHUB_OUTPUT
            # Default to dev image names for manual promotion
            echo "ploston_full=${REGISTRY}/${ORG}/${PLOSTON_DEV_IMAGE}" >> $GITHUB_OUTPUT
            echo "native_tools_full=${REGISTRY}/${ORG}/${NATIVE_TOOLS_DEV_IMAGE}" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # For repository_dispatch and manual: re-tag existing RC image
      - name: Pull and re-tag RC image (ploston)
        if: github.event_name != 'release'
        run: |
          docker pull ${{ steps.params.outputs.image }}
          IFS=',' read -ra TAGS <<< "${{ steps.params.outputs.tags }}"
          for tag in "${TAGS[@]}"; do
            docker tag ${{ steps.params.outputs.image }} ${{ steps.params.outputs.ploston_full }}:${tag}
            docker push ${{ steps.params.outputs.ploston_full }}:${tag}
            echo "Pushed ${{ steps.params.outputs.ploston_full }}:${tag}"
          done

      - name: Pull and re-tag RC image (native-tools)
        if: github.event_name == 'repository_dispatch' && steps.params.outputs.native_tools_image != ''
        run: |
          docker pull ${{ steps.params.outputs.native_tools_image }}
          IFS=',' read -ra TAGS <<< "${{ steps.params.outputs.tags }}"
          for tag in "${TAGS[@]}"; do
            docker tag ${{ steps.params.outputs.native_tools_image }} ${{ steps.params.outputs.native_tools_full }}:${tag}
            docker push ${{ steps.params.outputs.native_tools_full }}:${tag}
            echo "Pushed ${{ steps.params.outputs.native_tools_full }}:${tag}"
          done

      # For releases: checkout and build fresh with version tags
      - name: Checkout meta-repo
        if: github.event_name == 'release'
        uses: actions/checkout@v4
        with:
          repository: ostanlabs/agent-execution-layer
          submodules: recursive
          token: ${{ secrets.META_REPO_TOKEN }}

      - name: Set up Docker Buildx
        if: github.event_name == 'release'
        uses: docker/setup-buildx-action@v3

      - name: Build and push release images
        if: github.event_name == 'release'
        run: |
          IFS=',' read -ra TAGS <<< "${{ steps.params.outputs.tags }}"
          TAG_ARGS=""
          for tag in "${TAGS[@]}"; do
            TAG_ARGS="$TAG_ARGS -t ${{ steps.params.outputs.ploston_full }}:${tag}"
          done
          docker buildx build --push $TAG_ARGS .

      - name: Summary
        run: |
          echo "## üéâ Promoted!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ steps.params.outputs.source }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.params.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.params.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY

  notify-dashboard-dev:
    name: Notify Dashboard (Dev)
    if: github.event_name == 'repository_dispatch'
    needs: [promote]
    runs-on: ubuntu-latest

    steps:
      - name: Trigger dashboard refresh for dev image
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: dev-promoted
          client-payload: |
            {
              "package": "ploston",
              "tag": "dev-${{ needs.promote.outputs.short_sha }}",
              "sha": "${{ github.event.client_payload.sha }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }

  notify-dashboard-release:
    name: Notify Dashboard (Release)
    if: github.event_name == 'release'
    needs: [promote]
    runs-on: ubuntu-latest

    steps:
      - name: Trigger dashboard refresh
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: release-published
          client-payload: |
            {
              "package": "ploston",
              "version": "${{ github.event.release.tag_name }}",
              "release_url": "${{ github.event.release.html_url }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }

  notify-slack:
    name: Notify Slack
    if: always()
    needs: [promote]
    runs-on: ubuntu-latest

    steps:
      - name: Send success notification
        if: needs.promote.result == 'success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚úÖ Deployed: ploston ${{ github.event_name == 'release' && github.event.release.tag_name || 'latest' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Deployed: ploston"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ github.event_name == 'release' && github.event.release.tag_name || 'latest' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Registry:*\n<https://hub.docker.com/r/ostanlabs/ploston|Docker Hub>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Send failure notification
        if: needs.promote.result == 'failure'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚ùå Deploy Failed: ploston",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Deploy Failed: ploston"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Trigger:*\n${{ github.event_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
