# =============================================================================
# Promote - Release RC to Production
# =============================================================================
# Promotes RC images to production tags.
#
# Triggers:
#   - repository_dispatch (rc-tests-passed): Auto-promote after E2E tests pass
#     ‚Üí Tags: :latest, :main
#   - GitHub Release: Versioned release
#     ‚Üí Tags: :v1.0.0, :1.0, :1, :latest
#   - Manual: Specify RC image and target tags
# =============================================================================

name: Promote

on:
  repository_dispatch:
    types: [rc-tests-passed]

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      image:
        description: 'RC image to promote (e.g., docker.io/ostanlabs/ploston:rc-abc1234-core-def5678)'
        required: true
      tags:
        description: 'Comma-separated tags to apply (e.g., latest,main)'
        required: true
        default: 'latest,main'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ostanlabs/ploston
  NATIVE_TOOLS_IMAGE_NAME: ostanlabs/native-tools

jobs:
  promote:
    name: Promote to Production
    runs-on: ubuntu-latest

    steps:
      - name: Determine promotion parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "image=${{ github.event.client_payload.image }}" >> $GITHUB_OUTPUT
            echo "native_tools_image=${{ github.event.client_payload.native_tools_image }}" >> $GITHUB_OUTPUT
            echo "tags=latest,main" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
            echo "source=e2e-passed" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            # For releases, we need to find the latest RC or build fresh
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            echo "tags=${VERSION},${MAJOR}.${MINOR},${MAJOR},latest" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "source=release" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "image=${{ github.event.inputs.image }}" >> $GITHUB_OUTPUT
            echo "tags=${{ github.event.inputs.tags }}" >> $GITHUB_OUTPUT
            echo "sha=manual" >> $GITHUB_OUTPUT
            echo "source=manual" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # For repository_dispatch and manual: re-tag existing RC image
      - name: Pull and re-tag RC image (ploston)
        if: github.event_name != 'release'
        run: |
          docker pull ${{ steps.params.outputs.image }}
          IFS=',' read -ra TAGS <<< "${{ steps.params.outputs.tags }}"
          for tag in "${TAGS[@]}"; do
            docker tag ${{ steps.params.outputs.image }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}
            echo "Pushed ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}"
          done

      - name: Pull and re-tag RC image (native-tools)
        if: github.event_name == 'repository_dispatch' && steps.params.outputs.native_tools_image != ''
        run: |
          docker pull ${{ steps.params.outputs.native_tools_image }}
          IFS=',' read -ra TAGS <<< "${{ steps.params.outputs.tags }}"
          for tag in "${TAGS[@]}"; do
            docker tag ${{ steps.params.outputs.native_tools_image }} ${{ env.REGISTRY }}/${{ env.NATIVE_TOOLS_IMAGE_NAME }}:${tag}
            docker push ${{ env.REGISTRY }}/${{ env.NATIVE_TOOLS_IMAGE_NAME }}:${tag}
            echo "Pushed ${{ env.REGISTRY }}/${{ env.NATIVE_TOOLS_IMAGE_NAME }}:${tag}"
          done

      # For releases: checkout and build fresh with version tags
      - name: Checkout meta-repo
        if: github.event_name == 'release'
        uses: actions/checkout@v4
        with:
          repository: ostanlabs/agent-execution-layer
          submodules: recursive
          token: ${{ secrets.META_REPO_TOKEN }}

      - name: Set up Docker Buildx
        if: github.event_name == 'release'
        uses: docker/setup-buildx-action@v3

      - name: Build and push release images
        if: github.event_name == 'release'
        run: |
          IFS=',' read -ra TAGS <<< "${{ steps.params.outputs.tags }}"
          TAG_ARGS=""
          for tag in "${TAGS[@]}"; do
            TAG_ARGS="$TAG_ARGS -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}"
          done
          docker buildx build --push $TAG_ARGS .

      - name: Summary
        run: |
          echo "## üéâ Promoted to Production!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ steps.params.outputs.source }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.params.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  notify-dashboard:
    name: Notify Dashboard
    if: github.event_name == 'release'
    needs: [promote]
    runs-on: ubuntu-latest

    steps:
      - name: Trigger dashboard refresh
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: release-published
          client-payload: |
            {
              "package": "ploston",
              "version": "${{ github.event.release.tag_name }}",
              "release_url": "${{ github.event.release.html_url }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }

  notify-slack:
    name: Notify Slack
    if: always()
    needs: [promote]
    runs-on: ubuntu-latest

    steps:
      - name: Send success notification
        if: needs.promote.result == 'success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚úÖ Deployed: ploston ${{ github.event_name == 'release' && github.event.release.tag_name || 'latest' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Deployed: ploston"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ github.event_name == 'release' && github.event.release.tag_name || 'latest' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Registry:*\n<https://hub.docker.com/r/ostanlabs/ploston|Docker Hub>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Send failure notification
        if: needs.promote.result == 'failure'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚ùå Deploy Failed: ploston",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Deploy Failed: ploston"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Trigger:*\n${{ github.event_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
