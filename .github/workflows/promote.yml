# =============================================================================
# Promote - Retag dev images to edge
# =============================================================================
# Triggered by meta-repo after integration tests pass.
# Promotes dev images (sha-xxx) to edge tag.
#
# Both ploston and native-tools images are promoted together.
# =============================================================================

name: Promote

on:
  repository_dispatch:
    types: [promote]

  workflow_dispatch:
    inputs:
      source_tag:
        description: 'Source tag to promote (e.g., sha-abc1234)'
        required: true

env:
  REGISTRY: ghcr.io

jobs:
  promote:
    name: Promote to Edge
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine source tag
        id: params
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            SOURCE_TAG="${{ github.event.client_payload.source_tag }}"
          else
            SOURCE_TAG="${{ github.event.inputs.source_tag }}"
          fi
          echo "source_tag=$SOURCE_TAG" >> $GITHUB_OUTPUT

      - name: Promote ploston image to edge
        run: |
          SOURCE="${{ env.REGISTRY }}/ostanlabs/ploston-dev:${{ steps.params.outputs.source_tag }}"
          TARGET="${{ env.REGISTRY }}/ostanlabs/ploston-dev:edge"

          docker pull $SOURCE
          docker tag $SOURCE $TARGET
          docker push $TARGET
          echo "::notice::Promoted $SOURCE ‚Üí $TARGET"

      - name: Promote native-tools image to edge
        run: |
          SOURCE="${{ env.REGISTRY }}/ostanlabs/native-tools-dev:${{ steps.params.outputs.source_tag }}"
          TARGET="${{ env.REGISTRY }}/ostanlabs/native-tools-dev:edge"

          docker pull $SOURCE
          docker tag $SOURCE $TARGET
          docker push $TARGET
          echo "::notice::Promoted $SOURCE ‚Üí $TARGET"

      - name: Summary
        run: |
          echo "## üéâ Promoted to Edge!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source Tag:** ${{ steps.params.outputs.source_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Tag:** edge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Promoted:" >> $GITHUB_STEP_SUMMARY
          echo "- ploston-dev:${{ steps.params.outputs.source_tag }} ‚Üí ploston-dev:edge" >> $GITHUB_STEP_SUMMARY
          echo "- native-tools-dev:${{ steps.params.outputs.source_tag }} ‚Üí native-tools-dev:edge" >> $GITHUB_STEP_SUMMARY

  report-success:
    name: Report Success to Meta-Repo
    needs: [promote]
    if: success() && github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Dispatch promote-complete (success)
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: promote-complete
          client-payload: |
            {
              "repo": "ploston",
              "status": "success",
              "error": null,
              "cascade_id": "${{ github.event.client_payload.cascade_id }}"
            }

  report-failure:
    name: Report Failure to Meta-Repo
    needs: [promote]
    if: failure() && github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Dispatch promote-complete (failure)
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: promote-complete
          client-payload: |
            {
              "repo": "ploston",
              "status": "failure",
              "error": "Promotion failed - check workflow run for details",
              "cascade_id": "${{ github.event.client_payload.cascade_id }}"
            }

  notify-slack:
    name: Notify Slack
    if: always()
    needs: [promote]
    runs-on: ubuntu-latest

    steps:
      - name: Send success notification
        if: needs.promote.result == 'success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚úÖ Promoted: ploston to edge",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Promoted: ploston"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Target:*\nedge"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Registry:*\n<https://ghcr.io/ostanlabs/ploston-dev|GHCR>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Send failure notification
        if: needs.promote.result == 'failure'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "‚ùå Promotion Failed: ploston",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Promotion Failed: ploston"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Trigger:*\n${{ github.event_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
