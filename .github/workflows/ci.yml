# =============================================================================
# Ploston CI Workflow
# =============================================================================
# Runs lint and unit tests, builds Docker images, reports to meta-repo.
#
# Triggers:
#   - Push to main: Full CI + trigger meta-repo integration tests
#   - Pull request: Lint + unit tests only
#   - workflow_dispatch: Triggered by meta-repo for coordinated builds
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      ploston_core_version:
        description: 'ploston-core version to use (git ref, e.g., main, sha, or tag). Empty = latest PyPI'
        required: false
        default: ''
      ploston_core_sha:
        description: 'ploston-core commit SHA (for image tagging)'
        required: false
        default: ''
      meta_run_id:
        description: 'Meta-repo run ID (for callback)'
        required: false
        default: ''

# Prevent concurrent runs on the same branch/ref
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run lint
        run: make lint
        # Note: `make lint` includes format check via `ruff format --check`

  unit-tests:
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run unit tests
        run: |
          uv sync --all-extras
          make test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: junit-results.xml

  # ===========================================================================
  # Build Docker Images
  # ===========================================================================
  # Only runs on main branch or workflow_dispatch (meta-repo trigger)
  # Builds both ploston and native-tools images
  # ===========================================================================
  build-images:
    needs: unit-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      ploston_image: ${{ steps.build-ploston.outputs.image }}
      native_tools_image: ${{ steps.build-native-tools.outputs.image }}
      image_tag: ${{ steps.tags.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine image tags
        id: tags
        run: |
          # Use ploston-core SHA if provided, otherwise use this repo's SHA
          # Always use short SHA (7 chars) for consistency
          # Tag format: sha-<7char_hash> (matches ci/image-config.env DEV_TAG_TEMPLATE)
          if [ -n "${{ inputs.ploston_core_sha }}" ]; then
            SHORT_SHA=$(echo "${{ inputs.ploston_core_sha }}" | cut -c1-7)
            TAG="sha-${SHORT_SHA}"
          else
            TAG="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "::notice::Image tag: $TAG"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.META_REPO_TOKEN }}

      - name: Build and push ploston image
        id: build-ploston
        run: |
          IMAGE="${{ env.REGISTRY }}/ostanlabs/ploston-dev:${{ steps.tags.outputs.tag }}"

          # Build with optional ploston-core git ref
          # If PLOSTON_CORE_REF is empty, Dockerfile uses PyPI version
          docker build \
            --build-arg PLOSTON_CORE_REF="${{ inputs.ploston_core_version }}" \
            --label "org.opencontainers.image.source=https://github.com/ostanlabs/ploston" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "com.ostanlabs.ploston-core.ref=${{ inputs.ploston_core_version }}" \
            --label "com.ostanlabs.ploston-core.sha=${{ inputs.ploston_core_sha }}" \
            -t $IMAGE \
            -f Dockerfile .

          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "::notice::Built ploston image: $IMAGE"

      - name: Build and push native-tools image
        id: build-native-tools
        run: |
          IMAGE="${{ env.REGISTRY }}/ostanlabs/native-tools-dev:${{ steps.tags.outputs.tag }}"

          # Build with optional ploston-core git ref
          docker build \
            --build-arg PLOSTON_CORE_REF="${{ inputs.ploston_core_version }}" \
            --label "org.opencontainers.image.source=https://github.com/ostanlabs/ploston" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "com.ostanlabs.ploston-core.ref=${{ inputs.ploston_core_version }}" \
            --label "com.ostanlabs.ploston-core.sha=${{ inputs.ploston_core_sha }}" \
            -t $IMAGE \
            -f docker/native-tools/Dockerfile .

          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "::notice::Built native-tools image: $IMAGE"


  # ===========================================================================
  # Report Results to Meta-Repo
  # ===========================================================================
  # When triggered by workflow_dispatch (from meta-repo), we don't send any event
  # back - the meta-repo uses `gh run watch` to wait for completion.
  #
  # When triggered by push to main (organic change), we send component-updated
  # to trigger the full meta-repo CI pipeline.
  # ===========================================================================

  # Trigger meta-repo test-and-promote when this repo changes organically (push to main)
  trigger-meta-repo:
    needs: [lint, unit-tests, build-images]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build-images.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Get ploston-core version from image
        id: core-version
        run: |
          # Extract ploston-core version from the built image
          # The version is stored as a label during build
          CORE_VERSION=$(docker inspect --format='{{index .Config.Labels "com.ostanlabs.ploston-core.version"}}' ${{ needs.build-images.outputs.ploston_image }} 2>/dev/null || echo "unknown")
          if [ "$CORE_VERSION" == "unknown" ] || [ -z "$CORE_VERSION" ]; then
            # Fallback: get from pyproject.toml dependency
            CORE_VERSION="latest"
          fi
          echo "version=$CORE_VERSION" >> $GITHUB_OUTPUT

      - name: Dispatch component-updated to meta-repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: component-updated
          client-payload: |
            {
              "repo": "ploston",
              "sha": "${{ github.sha }}",
              "core_version": "${{ steps.core-version.outputs.version }}",
              "images": {
                "ploston": "${{ needs.build-images.outputs.ploston_image }}",
                "native_tools": "${{ needs.build-images.outputs.native_tools_image }}"
              }
            }

  report-to-dashboard:
    name: Report to Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true
    needs: [lint, unit-tests]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-results
          path: test-results/

      - name: Parse test results
        id: parse
        run: |
          TOTAL_TESTS=0
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_SKIPPED=0

          if [ -d "test-results" ]; then
            for xml in test-results/*.xml; do
              if [ -f "$xml" ]; then
                TESTS=$(grep -oP 'tests="\K[0-9]+' "$xml" | head -1 || echo 0)
                FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xml" | head -1 || echo 0)
                ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xml" | head -1 || echo 0)
                SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$xml" | head -1 || echo 0)

                TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                TOTAL_FAILED=$((TOTAL_FAILED + FAILURES + ERRORS))
                TOTAL_SKIPPED=$((TOTAL_SKIPPED + SKIPPED))
              fi
            done
          fi

          TOTAL_PASSED=$((TOTAL_TESTS - TOTAL_FAILED - TOTAL_SKIPPED))

          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT

      - name: Get short SHA
        id: sha
        run: echo "short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Report to meta-repo dashboard
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: ci-results-ploston
          client-payload: |
            {
              "package": "ploston",
              "sha": "${{ github.sha }}",
              "short_sha": "${{ steps.sha.outputs.short }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "lint": "${{ needs.lint.result }}",
              "test": "${{ needs.unit-tests.result }}",
              "tests": {
                "total": ${{ steps.parse.outputs.total }},
                "passed": ${{ steps.parse.outputs.passed }},
                "failed": ${{ steps.parse.outputs.failed }},
                "skipped": ${{ steps.parse.outputs.skipped }}
              },
              "status": "${{ needs.lint.result == 'success' && needs.unit-tests.result == 'success' && 'success' || 'failure' }}"
            }
