# =============================================================================
# Release - Build and publish versioned release images
# =============================================================================
# Triggered when a version tag is pushed (e.g., v1.0.0).
# Builds release images and notifies meta-repo dashboard.
#
# Tags created:
#   - ploston:v1.0.0, ploston:1.0, ploston:1, ploston:latest
#   - native-tools:v1.0.0, native-tools:1.0, native-tools:1, native-tools:latest
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  release:
    name: Build and Push Release Images
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "tags=$VERSION,${MAJOR}.${MINOR},${MAJOR},latest" >> $GITHUB_OUTPUT

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ploston release image
        run: |
          IFS=',' read -ra TAGS <<< "${{ steps.version.outputs.tags }}"
          TAG_ARGS=""
          for tag in "${TAGS[@]}"; do
            TAG_ARGS="$TAG_ARGS -t ${{ env.REGISTRY }}/ostanlabs/ploston:${tag}"
          done

          docker buildx build --push $TAG_ARGS \
            --label "org.opencontainers.image.source=https://github.com/ostanlabs/ploston" \
            --label "org.opencontainers.image.version=${{ steps.version.outputs.version }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            -f Dockerfile .

          echo "::notice::Built ploston release images with tags: ${{ steps.version.outputs.tags }}"

      - name: Build and push native-tools release image
        run: |
          IFS=',' read -ra TAGS <<< "${{ steps.version.outputs.tags }}"
          TAG_ARGS=""
          for tag in "${TAGS[@]}"; do
            TAG_ARGS="$TAG_ARGS -t ${{ env.REGISTRY }}/ostanlabs/native-tools:${tag}"
          done

          docker buildx build --push $TAG_ARGS \
            --label "org.opencontainers.image.source=https://github.com/ostanlabs/ploston" \
            --label "org.opencontainers.image.version=${{ steps.version.outputs.version }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            -f docker/native-tools/Dockerfile .

          echo "::notice::Built native-tools release images with tags: ${{ steps.version.outputs.tags }}"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.version.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images:" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/ostanlabs/ploston:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/ostanlabs/native-tools:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  notify-dashboard:
    name: Notify Dashboard
    needs: [release]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Dispatch release-published to meta-repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: release-published
          client-payload: |
            {
              "repo": "ploston",
              "version": "${{ needs.release.outputs.version }}",
              "sha": "${{ github.sha }}"
            }

  notify-slack:
    name: Notify Slack
    if: always()
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Send release notification
        if: needs.release.result == 'success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "ðŸš€ Released: ploston v${{ needs.release.outputs.version }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš€ Released: ploston v${{ needs.release.outputs.version }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ needs.release.outputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Registry:*\n<https://ghcr.io/ostanlabs/ploston|GHCR>"
                    }
                  ]
                }
              ]
            }

